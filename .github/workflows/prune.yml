name: Git LFS Maintenance

on:
  push:
    branches:
      - "lfs-test"
  pull_request:
    branches:
      - "master"
    paths:
      - ".github/workflows/prune.yaml"
  workflow_dispatch:

jobs:
  lfs-maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Git LFS
        run: |
          git lfs install

      - name: Check LFS objects size
        run: |
          echo "Current LFS objects size:"
          git lfs ls-files -l | awk '{total += $4} END {print total/1024/1024 " MB"}'

      - name: List all LFS files
        run: |
          echo "Current LFS tracked files:"
          git lfs ls-files

      - name: Prune old LFS objects
        run: |
          # Fetch all LFS objects first
          git lfs fetch --all

          # Remove local LFS objects
          git lfs prune

          # Force remove all LFS objects from remote
          git lfs push --all origin --force

      - name: Verify cleanup
        run: |
          echo "Remaining LFS objects size after cleanup:"
          git lfs ls-files -l | awk '{total += $4} END {print total/1024/1024 " MB"}'

      - name: Garbage collection
        run: |
          git gc --aggressive --prune=now
