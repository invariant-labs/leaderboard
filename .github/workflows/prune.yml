name: Git LFS Maintenance

on:
  push:
    branches:
      - "lfs-test"
  pull_request:
    branches:
      - "master"
    paths:
      - ".github/workflows/prune.yaml"
  workflow_dispatch:

jobs:
  lfs-maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: Shallow clone without LFS
        run: |
          git clone --no-checkout --depth 1 https://${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git .
          git config lfs.fetchexclude "*"

      - name: Configure Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git config --global http.https://github.com/.extraheader "AUTHORIZATION: basic ${{ secrets.GITHUB_TOKEN }}"

      - name: Clean LFS objects
        run: |
          # Initialize LFS but don't download objects
          git lfs install --skip-smudge

          # Get list of LFS files
          git lfs ls-files -l | tee lfs_files.txt

          # Calculate total size
          echo "Current LFS objects size:"
          cat lfs_files.txt | awk '{total += $4} END {print total/1024/1024 " MB"}'

          # Untrack LFS files temporarily
          git lfs untrack "**/*"
          git add .gitattributes

          # Clean LFS objects from remote
          git lfs prune --verify-remote

      - name: Re-enable LFS tracking
        run: |
          # Re-track original LFS patterns
          if [ -f .gitattributes.backup ]; then
            mv .gitattributes.backup .gitattributes
            git add .gitattributes
          fi

          # Re-initialize LFS properly
          git lfs install

      - name: Update repository
        run: |
          # Fetch lfs-test branch without LFS
          git fetch origin lfs-test --no-tags

          # Create/update lfs-test branch
          git checkout -B lfs-test

          echo "Repository updated. LFS objects cleaned."

      - name: Verify cleanup
        run: |
          echo "Remaining LFS objects size:"
          git lfs ls-files -l | awk '{total += $4} END {print total/1024/1024 " MB" }'

      - name: Push changes
        run: |
          git remote set-url origin https://${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git
          git push origin lfs-test --force
